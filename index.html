<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode/QR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #video {
            width: 100%;
            height: auto;
            border-radius: 12px;
            background: #000;
        }
        
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #5D5CDE;
            border-radius: 12px;
            pointer-events: none;
        }
        
        .scan-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid rgba(93, 92, 222, 0.3);
            border-radius: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-6 max-w-md">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2 text-center">
                üì± Warehouse Scanner
            </h1>
            <p class="text-gray-600 dark:text-gray-300 text-center text-sm mb-6">
                Scan barcodes and QR codes to manage inventory
            </p>

            <div id="scanner-container" class="mb-6">
                <video id="video" autoplay muted playsinline class="hidden"></video>
                <div class="scan-overlay hidden"></div>
                <div id="camera-placeholder" class="bg-gray-100 dark:bg-gray-700 rounded-xl h-64 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üì∑</div>
                        <button id="start-camera" class="bg-[#5D5CDE] text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                            Start Camera
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div id="status" class="text-center text-sm text-gray-600 dark:text-gray-400">
                    Ready to scan
                </div>
                
                <div id="last-scan" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 hidden">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Last Scanned:</div>
                    <div id="last-scan-value" class="font-mono text-sm break-all"></div>
                </div>

                <div class="flex gap-3">
                    <button id="stop-camera" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-600 transition-colors disabled:opacity-50" disabled>
                        Stop Camera
                    </button>
                    <button id="commit-changes" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition-colors">
                        Commit Changes
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                üìä Dataset Preview (Last 5 items)
            </h2>
            <div id="dataset-preview" class="space-y-2">
                </div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-3 text-center">
                Total items: <span id="total-items">0</span>
            </div>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-sm w-full mx-4 p-6">
            <div id="modal-content">
                </div>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-sm w-full mx-4 p-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Add New Item</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Serial Number:</label>
                    <input id="new-serial" type="text" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Item Serial ID:</label>
                    <input id="new-item-id" type="text" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div class="flex gap-3 pt-2">
                    <button id="cancel-add" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-add" class="flex-1 px-4 py-2 bg-[#5D5CDE] text-white hover:bg-purple-700 rounded-lg transition-colors">
                        Add Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class WarehouseScanner {
            constructor() {
                this.codeReader = new ZXing.BrowserMultiFormatReader();
                this.isScanning = false;
                this.dataset = [];
                this.lastScanTime = 0;
                this.scanCooldown = 2000;
                
                // GitHub API Configuration
                // WARNING: This token is public! Use a dedicated token with minimal permissions.
                // Replace these values with your own.
                this.githubToken = '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';
                this.githubOwner = 'aqeel1415';
                this.githubRepo = 'InventoryBC';
                this.githubPath = 'data/dataset.xml';
                this.githubSha = null;

                this.initializeElements();
                this.bindEvents();
                this.loadDatasetFromGitHub();
            }

            initializeElements() {
                this.video = document.getElementById('video');
                this.startBtn = document.getElementById('start-camera');
                this.stopBtn = document.getElementById('stop-camera');
                this.status = document.getElementById('status');
                this.placeholder = document.getElementById('camera-placeholder');
                this.overlay = document.querySelector('.scan-overlay');
                this.lastScan = document.getElementById('last-scan');
                this.lastScanValue = document.getElementById('last-scan-value');
                this.resultModal = document.getElementById('result-modal');
                this.addModal = document.getElementById('add-modal');
                this.commitBtn = document.getElementById('commit-changes');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
                this.commitBtn.addEventListener('click', () => this.commitChanges());
                
                document.getElementById('cancel-add').addEventListener('click', () => this.hideAddModal());
                document.getElementById('confirm-add').addEventListener('click', () => this.confirmAdd());
                
                [this.resultModal, this.addModal].forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });
                });
            }

            async loadDatasetFromGitHub() {
                this.status.textContent = 'Loading dataset from GitHub...';
                try {
                const url = `https://api.github.com/repos/${this.githubOwner}/${this.githubRepo}/contents/${this.githubPath}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${this.githubToken}`,
                            'Accept': 'application/vnd.github.v3.raw'
                        }
                    });
                    if (!response.ok) throw new Error('Failed to fetch dataset. Check your token and repo info.');
                    
                    const xmlString = await response.text();
                    this.dataset = this.parseXml(xmlString);
                    this.updateDatasetPreview();
                    this.status.textContent = 'Dataset loaded. Ready to scan.';
                    
                    // Get the file's SHA for updating later
                    const fileInfoResponse = await fetch(url, {
                        headers: { 'Authorization': `token ${this.githubToken}` }
                    });
                    const fileInfo = await fileInfoResponse.json();
                    this.githubSha = fileInfo.sha;

                } catch (error) {
                    console.error('GitHub load error:', error);
                    this.status.textContent = 'Error loading dataset. Check console for details.';
                }
            }

            parseXml(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                const items = Array.from(xmlDoc.getElementsByTagName('item'));
                return items.map(item => ({
                    itemSerialID: parseInt(item.getElementsByTagName('itemSerialID')[0].textContent),
                    serialNumber: item.getElementsByTagName('serialNumber')[0].textContent
                }));
            }

            convertToXml(dataset) {
                const doc = document.implementation.createDocument(null, 'inventory');
                const inventory = doc.documentElement;
                dataset.forEach(item => {
                    const itemElement = doc.createElement('item');
                    const idElement = doc.createElement('itemSerialID');
                    idElement.textContent = item.itemSerialID;
                    const serialElement = doc.createElement('serialNumber');
                    serialElement.textContent = item.serialNumber;
                    itemElement.appendChild(idElement);
                    itemElement.appendChild(serialElement);
                    inventory.appendChild(itemElement);
                });
                return new XMLSerializer().serializeToString(doc);
            }

            async commitChanges() {
                this.status.textContent = 'Committing changes to GitHub...';
                this.commitBtn.disabled = true;

                const newXmlString = this.convertToXml(this.dataset);
                const base64Content = btoa(newXmlString);

                const url = `https://api.github.com/repos/${this.githubOwner}/${this.githubRepo}/contents/${this.githubPath}`;
                const payload = {
                    message: `Update from scanner app at ${new Date().toISOString()}`,
                    content: base64Content,
                    sha: this.githubSha
                };

                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(`GitHub API Error: ${errorData.message}`);
                    }
                    
                    const result = await response.json();
                    this.githubSha = result.content.sha;
                    this.status.textContent = 'Changes committed successfully!';

                } catch (error) {
                    console.error('GitHub commit error:', error);
                    this.status.textContent = 'Error committing changes. Check console.';
                } finally {
                    this.commitBtn.disabled = false;
                }
            }

            async startCamera() {
                try {
                    this.status.textContent = 'Requesting camera permission...';
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    this.placeholder.classList.add('hidden');
                    this.video.classList.remove('hidden');
                    this.overlay.classList.remove('hidden');
                    
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.isScanning = true;
                    
                    this.status.textContent = 'Camera ready - Point at barcode or QR code';
                    this.scanContinuously();
                } catch (error) {
                    console.error('Camera access error:', error);
                    this.status.textContent = 'Camera access denied or not available';
                    this.showCameraError();
                }
            }

            async scanContinuously() {
                if (!this.isScanning) return;
                
                try {
                    const result = await this.codeReader.decodeOnceFromVideoDevice(undefined, this.video.id);
                    const now = Date.now();
                    
                    if (now - this.lastScanTime > this.scanCooldown) {
                        this.lastScanTime = now;
                        this.handleScanResult(result.text);
                    }
                } catch (error) {
                    // No code detected
                }
                
                if (this.isScanning) {
                    setTimeout(() => this.scanContinuously(), 500);
                }
            }

            handleScanResult(scannedValue) {
                this.lastScan.classList.remove('hidden');
                this.lastScanValue.textContent = scannedValue;
                
                const existingItem = this.dataset.find(item => item.serialNumber === scannedValue);
                
                if (existingItem) {
                    this.showFoundResult(existingItem);
                } else {
                    this.showNotFoundResult(scannedValue);
                }
            }

            showFoundResult(item) {
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-3">‚úÖ</div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Item Found!</h3>
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Item Serial ID:</div>
                            <div class="font-semibold text-green-700 dark:text-green-400 text-lg">${item.itemSerialID}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-1">Serial Number:</div>
                            <div class="font-mono text-sm break-all text-gray-800 dark:text-gray-200">${item.serialNumber}</div>
                        </div>
                        <button onclick="document.getElementById('result-modal').classList.add('hidden')" 
                                class="w-full px-4 py-2 bg-[#5D5CDE] text-white hover:bg-purple-700 rounded-lg transition-colors">
                            Continue Scanning
                        </button>
                    </div>
                `;
                this.resultModal.classList.remove('hidden');
            }

            showNotFoundResult(scannedValue) {
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-3">‚ùì</div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Item Not Found</h3>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 mb-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Scanned Value:</div>
                            <div class="font-mono text-sm break-all text-gray-800 dark:text-gray-200">${scannedValue}</div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="document.getElementById('result-modal').classList.add('hidden'); scanner.showAddModal('${scannedValue}')" 
                                    class="w-full px-4 py-2 bg-green-500 text-white hover:bg-green-600 rounded-lg transition-colors">
                                Add to Dataset
                            </button>
                            <button onclick="document.getElementById('result-modal').classList.add('hidden')" 
                                    class="w-full px-4 py-2 bg-gray-500 text-white hover:bg-gray-600 rounded-lg transition-colors">
                                Continue Scanning
                            </button>
                        </div>
                    </div>
                `;
                this.resultModal.classList.remove('hidden');
            }

            showAddModal(scannedValue) {
                const nextId = this.getNextItemSerialID();
                document.getElementById('new-serial').value = scannedValue;
                document.getElementById('new-item-id').value = nextId;
                this.addModal.classList.remove('hidden');
            }

            hideAddModal() {
                this.addModal.classList.add('hidden');
            }

            confirmAdd() {
                const serialNumber = document.getElementById('new-serial').value;
                const itemSerialID = parseInt(document.getElementById('new-item-id').value);
                
                this.dataset.push({ itemSerialID, serialNumber });
                this.updateDatasetPreview();
                this.hideAddModal();
                
                this.status.textContent = `Added item ${itemSerialID} successfully! Click "Commit Changes" to save.`;
            }

            getNextItemSerialID() {
                if (this.dataset.length === 0) return 1;
                return Math.max(...this.dataset.map(item => item.itemSerialID)) + 1;
            }

            updateDatasetPreview() {
                const preview = document.getElementById('dataset-preview');
                const total = document.getElementById('total-items');
                
                total.textContent = this.dataset.length;
                
                if (this.dataset.length === 0) {
                    preview.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 text-sm py-4">No items yet</div>';
                    return;
                }
                
                const lastFive = this.dataset
                    .sort((a, b) => b.itemSerialID - a.itemSerialID)
                    .slice(0, 5);
                    
                preview.innerHTML = lastFive.map(item => `
                    <div class="flex justify-between items-center py-2 px-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="font-semibold text-sm">ID: ${item.itemSerialID}</span>
                        <span class="font-mono text-xs text-gray-600 dark:text-gray-400 truncate ml-2">${item.serialNumber}</span>
                    </div>
                `).join('');
            }

            stopCamera() {
                this.isScanning = false;
                
                if (this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                    this.video.srcObject = null;
                }
                
                this.video.classList.add('hidden');
                this.overlay.classList.add('hidden');
                this.placeholder.classList.remove('hidden');
                
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                
                this.status.textContent = 'Camera stopped';
            }

            showCameraError() {
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-3">‚ö†Ô∏è</div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Camera Not Available</h3>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Camera access is not available in this environment. To use this scanner:
                            <br><br>
                            1. Save this page as an HTML file<br>
                            2. Open it in a web browser<br>
                            3. Grant camera permission when prompted
                        </div>
                        <button onclick="document.getElementById('result-modal').classList.add('hidden')" 
                                class="w-full px-4 py-2 bg-[#5D5CDE] text-white hover:bg-purple-700 rounded-lg transition-colors">
                            OK
                        </button>
                    </div>
                `;
                this.resultModal.classList.remove('hidden');
            }
        }

        const scanner = new WarehouseScanner();
    </script>
</body>
</html>
